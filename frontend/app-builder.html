<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebView App Builder</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="navbar">
            <a href="#" class="logo">
                <img src="images/logo.svg" alt="WebView App Builder">
                <span class="logo-text">App Builder</span>
            </a>
            <div class="user-profile">
                <div class="avatar">U</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <ul class="sidebar-menu">
                    <li>
                        <a href="#" class="active">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 4v16m8-8H4"></path>
                            </svg>
                            Build & Download
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 17h5l-1.5-1.5M15 17v-3m0 0H9.5m0 0a2 2 0 10-4 0m0 0H5"></path>
                            </svg>
                            Push Notification
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            App Settings
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Hidden fields for API requirements -->
                <input type="hidden" id="github-token">
                <input type="hidden" id="repo-owner">
                <input type="hidden" id="repo-name">
                <input type="hidden" id="default-token-id">

                <!-- App Building Card -->
                <div class="card" id="build-app-card">
                    <h2 class="card-title">Build New App</h2>
                    
                    <div class="form-group">
                        <label for="app-name">App Name</label>
                        <input type="text" id="app-name" placeholder="Enter your app name">
                    </div>
                    
                    <div class="form-group">
                        <label for="webview-url">Website URL</label>
                        <input type="url" id="webview-url" placeholder="https://example.com">
                    </div>
                    
                    <button id="build-app-button" class="btn btn-primary btn-block">Build App</button>
                </div>
                
                <!-- Building Progress Card (initially hidden) -->
                <div class="card" id="building-progress" style="display: none;">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <h2>Building Your App...</h2>
                        <p>This process may take a few minutes. Your app is being compiled.</p>
                    </div>
                </div>
                
                <!-- App Ready Card (initially hidden) -->
                <div class="card" id="app-ready" style="display: none;">
                    <h2 class="card-title">Your App is Ready</h2>
                    
                    <div class="warning-box">
                        Installing an app from direct APK file will show a 'Google Play Protect' or virus detection warning. This warning is default by Android OS and will be gone when published to Google Play Store.
                    </div>
                    
                    <div class="app-ready-container">
                        <div class="app-info">
                            <h3>Download App</h3>
                            
                            <div class="download-option">
                                <div class="download-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 17l2-2 4 4 8-8 2 2-10 10L3 17z"></path>
                                    </svg>
                                </div>
                                <div class="download-details">
                                    <div class="download-title">Download APK</div>
                                    <div class="download-subtitle">Android Application Package</div>
                                    <div class="download-date" id="build-date">Generated just now</div>
                                </div>
                                <a href="#" id="download-apk-btn" class="btn btn-primary download-button">Download</a>
                            </div>
                            
                            <div class="download-option">
                                <div class="download-icon" style="background-color: #673AB7;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="8 18 12 22 16 18"></polyline>
                                        <path d="M12 2v20"></path>
                                    </svg>
                                </div>
                                <div class="download-details">
                                    <div class="download-title">Download AAB</div>
                                    <div class="download-subtitle">Android App Bundle</div>
                                    <div class="download-date">For Google Play submission</div>
                                </div>
                                <a href="#" class="btn btn-upgrade download-button">Upgrade Plan</a>
                            </div>
                        </div>
                        
                        <div class="app-qr">
                            <div class="qr-code-container">
                                <canvas id="app-qr-code" width="150" height="150"></canvas>
                            </div>
                            <p>Scan to download APK on your device</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Builds Card -->
                <div class="card">
                    <h2 class="card-title">Recent Builds</h2>
                    <button id="check-builds" class="btn btn-primary">View Recent Builds</button>
                    
                    <div id="builds-list" class="build-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        // Hidden configuration loading
        async function loadConfiguration() {
            try {
                // Try to get default token ID from server
                const response = await fetch('/api/default-token');
                const data = await response.json();
                
                if (data.success && data.tokenId) {
                    // Store the token ID
                    document.getElementById('default-token-id').value = data.tokenId;
                    
                    // Set owner/repo from server response
                    if (data.owner) document.getElementById('repo-owner').value = data.owner;
                    if (data.repo) document.getElementById('repo-name').value = data.repo;
                    
                    // Mark as having a token
                    document.getElementById('github-token').value = 'default-token-configured';
                    
                    console.log('Configuration loaded successfully');
                    return true;
                } else {
                    console.warn('No default token available on server');
                    return false;
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
                return false;
            }
        }
        
        // Create QR code
        function generateQRCode(url, element) {
            QRCode.toCanvas(element, url, { width: 150 }, function (error) {
                if (error) console.error('QR code error:', error);
            });
        }
        
        // Helper function for generating a build ID
        function generateBuildId() {
            return `build-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }
        
        // Build App Button Click Handler
        document.getElementById('build-app-button').addEventListener('click', async function() {
            const appName = document.getElementById('app-name').value;
            const webviewUrl = document.getElementById('webview-url').value;
            const token = document.getElementById('github-token').value;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            const tokenId = document.getElementById('default-token-id').value;
            const buildId = generateBuildId();
            
            // Validate inputs
            if (!appName || !webviewUrl) {
                alert('Please enter both App Name and Website URL');
                return;
            }
            
            if (!token && !tokenId) {
                alert('Configuration error. Please contact support.');
                return;
            }
            
            // Show building progress, hide other cards
            document.getElementById('build-app-card').style.display = 'none';
            document.getElementById('building-progress').style.display = 'block';
            document.getElementById('app-ready').style.display = 'none';
            
            try {
                // Determine which API endpoint to use based on available token
                let response;
                
                if (tokenId) {
                    // Use token ID for the request
                    response = await fetch(`/api/github-proxy/actions/workflows/build.yaml/dispatches?tokenId=${encodeURIComponent(tokenId)}&owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ref: 'main',
                            inputs: {
                                app_name: appName,
                                url: webviewUrl,
                                build_id: buildId
                            }
                        })
                    });
                } else {
                    // Use direct token
                    response = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/build.yaml/dispatches`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ref: 'main',
                            inputs: {
                                app_name: appName,
                                url: webviewUrl,
                                build_id: buildId
                            }
                        })
                    });
                }
                
                if (response.status === 204) {
                    // Build triggered successfully
                    console.log('Build triggered successfully');
                    
                    // Poll for build status
                    let buildCompleted = false;
                    let pollingCount = 0;
                    
                    const checkBuildStatus = async () => {
                        pollingCount++;
                        console.log(`Checking build status (attempt ${pollingCount})`);
                        
                        try {
                            // Find workflow runs
                            let workflowsResponse;
                            
                            if (tokenId) {
                                workflowsResponse = await fetch(`/api/github-proxy/actions/runs?tokenId=${encodeURIComponent(tokenId)}&owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}&per_page=5`);
                            } else {
                                workflowsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=5`, {
                                    headers: {
                                        'Authorization': `token ${token}`,
                                        'Accept': 'application/vnd.github.v3+json'
                                    }
                                });
                            }
                            
                            if (!workflowsResponse.ok) {
                                throw new Error(`API error: ${workflowsResponse.status}`);
                            }
                            
                            const workflowsData = await workflowsResponse.json();
                            
                            // Try to find our specific run
                            const ourRun = workflowsData.workflow_runs.find(run => {
                                return run.name === 'Android Build' && 
                                       (run.display_title?.includes(buildId) || 
                                        run.head_commit?.message?.includes(buildId));
                            });
                            
                            if (ourRun) {
                                console.log(`Found our run: ${ourRun.id}, status: ${ourRun.status}, conclusion: ${ourRun.conclusion}`);
                                
                                if (ourRun.status === 'completed') {
                                    buildCompleted = true;
                                    
                                    if (ourRun.conclusion === 'success') {
                                        // Get artifacts
                                        let artifactsResponse;
                                        
                                        if (tokenId) {
                                            artifactsResponse = await fetch(`/api/github-proxy/actions/runs/${ourRun.id}/artifacts?tokenId=${encodeURIComponent(tokenId)}&owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`);
                                        } else {
                                            artifactsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${ourRun.id}/artifacts`, {
                                                headers: {
                                                    'Authorization': `token ${token}`,
                                                    'Accept': 'application/vnd.github.v3+json'
                                                }
                                            });
                                        }
                                        
                                        if (artifactsResponse.ok) {
                                            const artifacts = await artifactsResponse.json();
                                            
                                            // Find APK artifact
                                            const apkArtifact = artifacts.artifacts.find(a => a.name === 'android-apk');
                                            
                                            if (apkArtifact) {
                                                // Get artifact URL
                                                const artifactUrl = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${apkArtifact.id}/zip`;
                                                const appFileName = `${appName.replace(/\s+/g, '-')}-${buildId}.apk`;
                                                
                                                // Create download link
                                                let downloadUrl;
                                                
                                                if (tokenId) {
                                                    // Use token ID endpoint
                                                    const proxyResponse = await fetch(`/api/token-download?tokenId=${encodeURIComponent(tokenId)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                                                    const proxyData = await proxyResponse.json();
                                                    
                                                    if (proxyResponse.ok && proxyData.success) {
                                                        downloadUrl = window.location.origin + proxyData.download_url;
                                                    }
                                                } else {
                                                    // Use direct token endpoint
                                                    const proxyResponse = await fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                                                    const proxyData = await proxyResponse.json();
                                                    
                                                    if (proxyResponse.ok && proxyData.success) {
                                                        downloadUrl = window.location.origin + proxyData.download_url;
                                                    }
                                                }
                                                
                                                if (downloadUrl) {
                                                    // Set the download button
                                                    document.getElementById('download-apk-btn').href = downloadUrl;
                                                    
                                                    // Generate QR code
                                                    generateQRCode(downloadUrl, document.getElementById('app-qr-code'));
                                                    
                                                    // Set the build date
                                                    document.getElementById('build-date').textContent = `Generated ${new Date().toLocaleDateString()}`;
                                                    
                                                    // Show the app ready card
                                                    document.getElementById('building-progress').style.display = 'none';
                                                    document.getElementById('app-ready').style.display = 'block';
                                                } else {
                                                    throw new Error('Failed to create download link');
                                                }
                                            } else {
                                                throw new Error('No APK artifact found');
                                            }
                                        } else {
                                            throw new Error(`Failed to get artifacts: ${artifactsResponse.status}`);
                                        }
                                    } else {
                                        // Build failed
                                        throw new Error(`Build failed with status: ${ourRun.conclusion}`);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error checking build status:', error);
                            
                            if (pollingCount > 30) {
                                buildCompleted = true;
                                alert(`Build failed: ${error.message}`);
                                document.getElementById('building-progress').style.display = 'none';
                                document.getElementById('build-app-card').style.display = 'block';
                            }
                        }
                        
                        if (buildCompleted) {
                            clearInterval(pollingInterval);
                        }
                    };
                    
                    // Check immediately first
                    await checkBuildStatus();
                    
                    // Then poll every 10 seconds
                    const pollingInterval = setInterval(checkBuildStatus, 10000);
                    
                    // Set timeout to prevent indefinite polling
                    setTimeout(() => {
                        if (!buildCompleted) {
                            clearInterval(pollingInterval);
                            alert('Build is taking longer than expected. Check Recent Builds later to see if it completed.');
                            document.getElementById('building-progress').style.display = 'none';
                            document.getElementById('build-app-card').style.display = 'block';
                        }
                    }, 300000); // 5 minutes
                    
                } else {
                    // Error triggering build
                    throw new Error(`Failed to trigger build: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Build error:', error);
                alert(`Error: ${error.message}`);
                document.getElementById('building-progress').style.display = 'none';
                document.getElementById('build-app-card').style.display = 'block';
            }
        });
        
        // Check Builds Button Click Handler
        document.getElementById('check-builds').addEventListener('click', async function() {
            const tokenId = document.getElementById('default-token-id').value;
            const token = document.getElementById('github-token').value;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            
            if ((!tokenId && !token) || !owner || !repo) {
                alert('Configuration error. Please try again later or contact support.');
                return;
            }
            
            const buildsList = document.getElementById('builds-list');
            buildsList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Loading recent builds...</p></div>';
            
            try {
                // Get workflow runs
                let workflowsResponse;
                
                if (tokenId) {
                    workflowsResponse = await fetch(`/api/github-proxy/actions/runs?tokenId=${encodeURIComponent(tokenId)}&owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}&status=completed&per_page=5`);
                } else {
                    workflowsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?status=completed&per_page=5`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                }
                
                if (!workflowsResponse.ok) {
                    throw new Error(`API error: ${workflowsResponse.status}`);
                }
                
                const workflowsData = await workflowsResponse.json();
                buildsList.innerHTML = '';
                
                // Filter for Android Build workflows
                const androidBuilds = workflowsData.workflow_runs.filter(run => run.name === 'Android Build');
                
                if (androidBuilds.length === 0) {
                    buildsList.innerHTML = '<p>No completed builds found.</p>';
                    return;
                }
                
                // Process each build
                for (const build of androidBuilds) {
                    // Parse build details
                    let appName = "WebView App";
                    let webviewUrl = "Unknown URL";
                    let buildId = "unknown";
                    
                    try {
                        if (build.display_title.includes('"app_name":')) {
                            appName = build.display_title.match(/"app_name":"([^"]+)"/)[1];
                        }
                        if (build.display_title.includes('"url":')) {
                            webviewUrl = build.display_title.match(/"url":"([^"]+)"/)[1];
                        }
                        if (build.display_title.includes('"build_id":')) {
                            buildId = build.display_title.match(/"build_id":"([^"]+)"/)[1];
                        }
                    } catch (e) {
                        console.error("Error parsing build details", e);
                    }
                    
                    // Create build item element
                    const buildItem = document.createElement('div');
                    buildItem.className = 'build-item';
                    
                    // Build info section
                    const buildInfo = document.createElement('div');
                    buildInfo.className = 'build-info';
                    
                    const buildStatus = build.conclusion === 'success' 
                        ? '<span class="badge badge-success">Success</span>' 
                        : '<span class="badge badge-error">Failed</span>';
                    
                    buildInfo.innerHTML = `
                        <h3>${appName}</h3>
                        <p><strong>Built on:</strong> ${new Date(build.created_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${buildStatus}</p>
                        <p><strong>Website URL:</strong> ${webviewUrl}</p>
                    `;
                    
                    buildItem.appendChild(buildInfo);
                    
                    // If build succeeded, get artifacts and create QR code
                    if (build.conclusion === 'success') {
                        // Create QR section placeholder
                        const qrSection = document.createElement('div');
                        qrSection.className = 'build-qr';
                        qrSection.innerHTML = '<div class="loading-spinner" style="width: 30px; height: 30px;"></div><p>Processing download...</p>';
                        buildItem.appendChild(qrSection);
                        
                        // Get artifacts
                        try {
                            let artifactsResponse;
                            
                            if (tokenId) {
                                artifactsResponse = await fetch(`/api/github-proxy/actions/runs/${build.id}/artifacts?tokenId=${encodeURIComponent(tokenId)}&owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}`);
                            } else {
                                artifactsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${build.id}/artifacts`, {
                                    headers: {
                                        'Authorization': `token ${token}`,
                                        'Accept': 'application/vnd.github.v3+json'
                                    }
                                });
                            }
                            
                            if (artifactsResponse.ok) {
                                const artifacts = await artifactsResponse.json();
                                
                                // Find APK artifact
                                const apkArtifact = artifacts.artifacts.find(a => a.name === 'android-apk');
                                
                                if (apkArtifact) {
                                    // Get artifact URL
                                    const artifactUrl = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${apkArtifact.id}/zip`;
                                    const appFileName = `${appName.replace(/\s+/g, '-')}-${buildId}.apk`;
                                    
                                    // Create download link
                                    let downloadUrl;
                                    
                                    if (tokenId) {
                                        const proxyResponse = await fetch(`/api/token-download?tokenId=${encodeURIComponent(tokenId)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                                        const proxyData = await proxyResponse.json();
                                        
                                        if (proxyResponse.ok && proxyData.success) {
                                            downloadUrl = window.location.origin + proxyData.download_url;
                                        }
                                    } else {
                                        const proxyResponse = await fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                                        const proxyData = await proxyResponse.json();
                                        
                                        if (proxyResponse.ok && proxyData.success) {
                                            downloadUrl = window.location.origin + proxyData.download_url;
                                        }
                                    }
                                    
                                    if (downloadUrl) {
                                        // Update QR section with QR code
                                        qrSection.innerHTML = `
                                            <div class="qr-code-container">
                                                <canvas id="qr-${buildId}" width="150" height="150"></canvas>
                                            </div>
                                            <a href="${downloadUrl}" class="btn btn-primary" style="margin-top: 10px;">Download APK</a>
                                            <p style="font-size: 12px; margin-top: 5px;">Scan with your phone</p>
                                        `;
                                        
                                        // Generate QR code
                                        generateQRCode(downloadUrl, document.getElementById(`qr-${buildId}`));
                                    } else {
                                        qrSection.innerHTML = '<p>Download link unavailable</p>';
                                    }
                                } else {
                                    qrSection.innerHTML = '<p>No APK artifact found</p>';
                                }
                            } else {
                                qrSection.innerHTML = '<p>Failed to load artifacts</p>';
                            }
                        } catch (error) {
                            console.error('Error processing artifacts:', error);
                            qrSection.innerHTML = `<p>Error: ${error.message}</p>`;
                        }
                    }
                    
                    buildsList.appendChild(buildItem);
                }
                
            } catch (error) {
                console.error('Error loading builds:', error);
                buildsList.innerHTML = `<div class="alert alert-error">Error loading builds: ${error.message}</div>`;
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
        });
    </script>
</body>
</html> 