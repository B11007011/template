<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebView App Builder (Repository Dispatch)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        h1 {
            margin-bottom: 30px;
        }
        h2 {
            margin-top: 30px;
            font-size: 1.5em;
        }
        .form-container, .builds-container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input[type="text"],
        input[type="url"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button, .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            width: 100%;
            transition: background-color 0.3s;
            text-align: center;
            text-decoration: none;
        }
        button:hover, .btn:hover {
            background-color: #2980b9;
        }
        .build-list {
            list-style: none;
            padding: 0;
        }
        .build-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .build-info {
            flex: 1;
            min-width: 250px;
        }
        .build-qr {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
        }
        .build-qr img {
            max-width: 150px;
            margin-top: 10px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .hidden {
            display: none;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            width: auto;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
        }
        .loading-container {
            text-align: center;
            padding: 30px 0;
        }
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .app-ready-container {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
        }
        .app-info {
            flex: 1;
            min-width: 300px;
        }
        .app-qr {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .warning-box {
            background-color: #fff3cd;
            color: #856404;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            padding-left: 50px;
        }
        .warning-box::before {
            content: "⚠️";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }
        .download-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .download-icon {
            width: 40px;
            height: 40px;
            background-color: #673ab7;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>WebView App Builder (Repository Dispatch)</h1>
    
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="build-form">Build New App</button>
            <button class="tab-button" data-tab="past-builds">Previous Builds</button>
        </div>
        
        <div class="tab-content" id="build-form">
            <div class="form-container">
                <!-- All GitHub and backend fields are hidden -->
                <input type="hidden" id="github-token">
                <input type="hidden" id="repo-owner">
                <input type="hidden" id="repo-name">
                <input type="hidden" id="auth-status">
                
                <div class="form-group">
                    <label for="app-name">App Name:</label>
                    <input type="text" id="app-name" placeholder="WebView App" required>
                </div>
                
                <div class="form-group">
                    <label for="webview-url">Website URL:</label>
                    <input type="url" id="webview-url" placeholder="https://example.com" required>
                </div>
                
                <div class="form-group">
                    <label for="build-id">Build ID (optional):</label>
                    <input type="text" id="build-id" placeholder="For tracking in Firestore">
                </div>
                
                <button id="trigger-build">Trigger Build</button>
            </div>
            
            <div id="result" class="result hidden"></div>
            
            <!-- Building in progress UI -->
            <div id="building-progress" class="hidden">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <h2>Building Your App...</h2>
                    <p>This process may take a few minutes. Please wait while we compile your Android application.</p>
                </div>
            </div>
            
            <!-- App ready UI (similar to screenshot) -->
            <div id="app-ready" class="hidden">
                <h2>Your App is Ready</h2>
                
                <div class="warning-box">
                    Installing an app from direct APK file will show a 'Google Play Protect' or virus detection warning. This warning is default by Android OS and will be gone when published to Google Play Store.
                </div>
                
                <div class="app-ready-container">
                    <div class="app-info">
                        <h3>Download App</h3>
                        
                        <div class="download-option">
                            <div class="download-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 17l2-2 4 4 8-8 2 2-10 10L3 17z"></path>
                                </svg>
                            </div>
                            <div>
                                <div><strong>Download APK</strong></div>
                                <div>Android Application Package</div>
                                <div><small id="build-date">Generated just now</small></div>
                            </div>
                            <a href="#" id="download-apk-btn" class="btn" style="width: auto; margin-left: auto; padding: 8px 15px;">Download</a>
                        </div>
                        
                        <div class="download-option">
                            <div class="download-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="8 18 12 22 16 18"></polyline>
                                    <path d="M12 2v20"></path>
                                </svg>
                            </div>
                            <div>
                                <div><strong>Download AAB</strong></div>
                                <div>Android App Bundle</div>
                                <div><small>For Google Play submission</small></div>
                            </div>
                            <a href="#" id="download-aab-btn" class="btn" style="width: auto; margin-left: auto; padding: 8px 15px; background-color: #673ab7;">Upgrade Plan</a>
                        </div>
                    </div>
                    
                    <div class="app-qr">
                        <canvas id="app-qr-code"></canvas>
                        <p>Scan to get the APK file download URL</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content hidden" id="past-builds">
            <div class="builds-container">
                <h2>Your Recent Builds</h2>
                
                <!-- All GitHub and backend fields are hidden -->
                <input type="hidden" id="check-github-token">
                <input type="hidden" id="check-repo-owner">
                <input type="hidden" id="check-repo-name">
                <input type="hidden" id="check-auth-status">
                
                <button id="check-builds">Check Recent Builds</button>
                
                <div id="builds-list" class="build-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Add Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <script>
        // Initialize Firebase based on config
        function initFirebase() {
            try {
                // Check if we have a config object
                if (typeof CONFIG !== 'undefined' && CONFIG.firebase) {
                    // Initialize Firebase
                    firebase.initializeApp(CONFIG.firebase);
                    console.log('Firebase initialized successfully');
                    return true;
                } else {
                    console.warn('Firebase config not found');
                    return false;
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
                return false;
            }
        }

        // Subscribe to Firestore updates for a specific build ID
        function subscribeToFirestoreUpdates(buildId) {
            try {
                if (!firebase.apps.length) {
                    console.warn('Firebase not initialized, cannot subscribe to updates');
                    return false;
                }
                
                const db = firebase.firestore();
                const buildingProgress = document.getElementById('building-progress');
                const appReady = document.getElementById('app-ready');
                
                // Subscribe to the document with the build ID
                return db.collection('builds').doc(buildId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const buildData = doc.data();
                            console.log('Build update:', buildData);
                            updateBuildProgress(buildData);
                        } else {
                            console.log('Build document does not exist');
                            // Create the document if it doesn't exist - this allows clients to track pending builds
                            db.collection('builds').doc(buildId).set({
                                status: 'pending',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }, (error) => {
                        console.error('Error listening to build updates:', error);
                        // Fall back to simulated behavior
                        setTimeout(() => {
                            buildingProgress.classList.add('hidden');
                            appReady.classList.remove('hidden');
                        }, 5000);
                    });
            } catch (error) {
                console.error('Error subscribing to Firestore:', error);
                return null;
            }
        }

        // Update the UI based on build status
        function updateBuildProgress(buildData) {
            const buildingProgress = document.getElementById('building-progress');
            const appReady = document.getElementById('app-ready');
            const resultDiv = document.getElementById('result');
            
            switch(buildData.status) {
                case 'pending':
                    // Build is queued but not started
                    buildingProgress.classList.remove('hidden');
                    appReady.classList.add('hidden');
                    resultDiv.className = 'result hidden';
                    break;
                    
                case 'in_progress':
                    // Build is currently running
                    buildingProgress.classList.remove('hidden');
                    appReady.classList.add('hidden');
                    resultDiv.className = 'result hidden';
                    break;
                    
                case 'completed':
                    // Build finished successfully
                    buildingProgress.classList.add('hidden');
                    appReady.classList.remove('hidden');
                    resultDiv.className = 'result hidden';
                    
                    // Set the build date
                    document.getElementById('build-date').textContent = `Generated ${new Date(buildData.completedAt.seconds * 1000).toLocaleDateString()}`;
                    
                    // Set the download button if we have an artifact URL
                    if (buildData.artifactUrl) {
                        const downloadBtn = document.getElementById('download-apk-btn');
                        const token = document.getElementById('github-token').value;
                        createDownloadLink(token, buildData.artifactUrl, `${buildData.appName || 'app'}.apk`);
                    }
                    
                    break;
                    
                case 'failed':
                    // Build failed
                    buildingProgress.classList.add('hidden');
                    appReady.classList.add('hidden');
                    resultDiv.textContent = `Build failed: ${buildData.error || 'Unknown error'}`;
                    resultDiv.className = 'result error';
                    break;
                    
                default:
                    console.warn('Unknown build status:', buildData.status);
            }
        }

        // Create download link for APK using our server proxy
        function createDownloadLink(token, artifactUrl, filename) {
            const downloadBtn = document.getElementById('download-apk-btn');
            
            if (!artifactUrl) {
                downloadBtn.textContent = 'No APK Available';
                downloadBtn.classList.add('disabled');
                return;
            }
            
            // Call our proxy API to get a direct download link
            fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Set the download link
                        downloadBtn.href = data.download_url;
                        downloadBtn.textContent = 'Download APK';
                        
                        // Generate QR code for direct download
                        const qrCanvas = document.getElementById('app-qr-code');
                        const fullDownloadUrl = window.location.origin + data.download_url;
                        generateQRCode(fullDownloadUrl, qrCanvas);
                    } else {
                        downloadBtn.textContent = 'Download Failed';
                        console.error('Download link error:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error creating download link:', error);
                    downloadBtn.textContent = 'Download Error';
                });
        }
        
        // Save settings in localStorage
        function saveSettings() {
            const settings = {
                repoOwner: document.getElementById('repo-owner').value,
                repoName: document.getElementById('repo-name').value,
                token: document.getElementById('github-token').value
            };
            localStorage.setItem('webviewAppSettings', JSON.stringify(settings));
        }
        
        // Load settings from localStorage
        function loadSettings() {
            // Default values
            const defaultValues = {
                repoOwner: 'B11007011',
                repoName: 'template',
                token: '' // No default token here
            };
            
            const settings = JSON.parse(localStorage.getItem('webviewAppSettings') || '{}');
            
            // Set default values first, then override with stored settings if they exist
            document.getElementById('repo-owner').value = defaultValues.repoOwner;
            document.getElementById('repo-name').value = defaultValues.repoName;
            
            // If there are stored settings, use them to override defaults
            if (settings.repoOwner) document.getElementById('repo-owner').value = settings.repoOwner;
            if (settings.repoName) document.getElementById('repo-name').value = settings.repoName;
            if (settings.token) document.getElementById('github-token').value = settings.token;
            
            // Copy the values to the "check builds" form too
            document.getElementById('check-repo-owner').value = document.getElementById('repo-owner').value;
            document.getElementById('check-repo-name').value = document.getElementById('repo-name').value;
            document.getElementById('check-github-token').value = document.getElementById('github-token').value;
                
            // Update auth status display based on token availability
            updateAuthStatus();
        }
        
        // Update authentication status messages
        function updateAuthStatus() {
            // No longer need to update UI elements since they're hidden
            // Just verify the token status in the background
            const hasToken = document.getElementById('github-token').value !== '';
            console.log('Authentication status:', hasToken ? 'Configured' : 'Not configured');
        }
        
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                // Show the selected tab content
                document.getElementById(button.dataset.tab).classList.remove('hidden');
            });
        });
        
        // Create QR code
        function generateQRCode(url, element) {
            QRCode.toCanvas(element, url, { width: 150 }, function (error) {
                if (error) console.error(error);
            });
        }
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            
            // Try to initialize Firebase
            initFirebase();
            
            // Load the config.js script
            const configScript = document.createElement('script');
            configScript.src = '/config.js';
            configScript.onload = function() {
                // Initialize Firebase once the config is loaded
                initFirebase();
            };
            configScript.onerror = function() {
                console.error('Failed to load config.js');
            };
            document.head.appendChild(configScript);
        });
        
        document.getElementById('trigger-build').addEventListener('click', async function() {
            const token = document.getElementById('github-token').value;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            const appName = document.getElementById('app-name').value;
            const webviewUrl = document.getElementById('webview-url').value;
            const buildId = document.getElementById('build-id').value || generateBuildId();
            
            // Save settings
            saveSettings();
            
            const resultDiv = document.getElementById('result');
            const buildingProgress = document.getElementById('building-progress');
            const appReady = document.getElementById('app-ready');
            
            resultDiv.className = 'result hidden';
            appReady.classList.add('hidden');
            
            // Validate inputs
            if (!token || !owner || !repo || !appName || !webviewUrl) {
                resultDiv.textContent = 'Please fill in all required fields';
                resultDiv.className = 'result error';
                return;
            }
            
            // Show building progress
            buildingProgress.classList.remove('hidden');
            
            try {
                // Using repository_dispatch event
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: 'build-android-request',
                        client_payload: {
                            app_name: appName,
                            url: webviewUrl,
                            build_id: buildId
                        }
                    })
                });
                
                if (response.status === 204) {
                    // Store this build in localStorage
                    const buildData = {
                        id: buildId,
                        appName,
                        webviewUrl,
                        owner,
                        repo,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    saveBuild(buildData);
                    
                    // Try to subscribe to Firestore updates
                    const firestoreSubscription = subscribeToFirestoreUpdates(buildId);
                    
                    // If Firestore isn't available, fall back to simulated behavior
                    if (!firestoreSubscription) {
                        // In a real scenario, we would poll the GitHub API to check build status
                        // For demo purposes, we'll simulate a build completion after 5 seconds
                        setTimeout(async function() {
                            buildingProgress.classList.add('hidden');
                            
                            // Set the build date
                            document.getElementById('build-date').textContent = `Generated ${new Date().toLocaleDateString()}`;
                            
                            // Normally we would get these URLs from the real build
                            // Here we're simulating for demonstration
                            const simulatedDownloadUrl = `/download/sample-${buildId}.apk`;
                            
                            // Set the download button
                            const downloadBtn = document.getElementById('download-apk-btn');
                            downloadBtn.href = simulatedDownloadUrl;
                            
                            // Generate QR code
                            const qrCanvas = document.getElementById('app-qr-code');
                            const fullDownloadUrl = window.location.origin + simulatedDownloadUrl;
                            generateQRCode(fullDownloadUrl, qrCanvas);
                            
                            // Show app ready view
                            appReady.classList.remove('hidden');
                        }, 5000); // Simulate 5 second build time
                    }
                    
                } else {
                    buildingProgress.classList.add('hidden');
                    const error = await response.json();
                    throw new Error(`GitHub API error: ${error.message}`);
                }
            } catch (error) {
                buildingProgress.classList.add('hidden');
                console.error('Error:', error);
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        });
        
        document.getElementById('check-builds').addEventListener('click', async function() {
            const token = document.getElementById('check-github-token').value;
            const owner = document.getElementById('check-repo-owner').value;
            const repo = document.getElementById('check-repo-name').value;
            
            if (!token || !owner || !repo) {
                alert('Configuration error. Please refresh the page or contact support.');
                return;
            }
            
            try {
                // Get workflows runs
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?status=completed&per_page=10`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                const buildsList = document.getElementById('builds-list');
                buildsList.innerHTML = '';
                
                if (data.workflow_runs.length === 0) {
                    buildsList.innerHTML = '<p>No completed builds found.</p>';
                    return;
                }
                
                // Loop through workflow runs and get artifacts
                for (const run of data.workflow_runs) {
                    if (run.name !== 'Android Build') continue;
                    
                    const artifactsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${run.id}/artifacts`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!artifactsResponse.ok) {
                        console.error(`Error fetching artifacts for run ${run.id}: ${artifactsResponse.status}`);
                        continue;
                    }
                    
                    const artifactsData = await artifactsResponse.json();
                    
                    const buildItem = document.createElement('div');
                    buildItem.className = 'build-item';
                    
                    const buildInfo = document.createElement('div');
                    buildInfo.className = 'build-info';
                    
                    // Extract parameters from run
                    let appName = "Unknown App";
                    let webviewUrl = "#";
                    let buildId = "unknown";
                    
                    try {
                        if (run.display_title.includes('"app_name":')) {
                            appName = run.display_title.match(/"app_name":"([^"]+)"/)[1];
                        }
                        if (run.display_title.includes('"url":')) {
                            webviewUrl = run.display_title.match(/"url":"([^"]+)"/)[1];
                        }
                        if (run.display_title.includes('"build_id":')) {
                            buildId = run.display_title.match(/"build_id":"([^"]+)"/)[1];
                        }
                    } catch (e) {
                        console.error("Error parsing run title", e);
                    }
                    
                    buildInfo.innerHTML = `
                        <h3>${appName || 'App Build'}</h3>
                        <p><strong>Built on:</strong> ${new Date(run.created_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${run.conclusion === 'success' ? '✅ Success' : '❌ Failed'}</p>
                        <p><strong>WebView URL:</strong> ${webviewUrl}</p>
                        <p><strong>Build ID:</strong> ${buildId || 'N/A'}</p>
                        <a href="${run.html_url}" target="_blank" class="btn">View Workflow Details</a>
                    `;
                    
                    buildItem.appendChild(buildInfo);
                    
                    // Find APK artifact
                    const apkArtifact = artifactsData.artifacts.find(a => a.name === 'android-apk');
                    if (apkArtifact) {
                        const qrContainer = document.createElement('div');
                        qrContainer.className = 'build-qr';
                        
                        // Instead of direct GitHub download URL, use our proxy API
                        const artifactUrl = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${apkArtifact.id}/zip`;
                        const appFileName = `${appName.replace(/\s+/g, '-')}-${buildId}.apk`;
                        
                        // Use our proxy download API to get a direct download link
                        const proxyResponse = await fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                        const proxyData = await proxyResponse.json();
                        
                        if (!proxyResponse.ok || !proxyData.success) {
                            qrContainer.innerHTML = `<strong>APK Download Failed</strong><p>Error: ${proxyData.error || 'Unknown error'}</p>`;
                        } else {
                            // Get the direct download URL from our server
                            const directDownloadUrl = window.location.origin + proxyData.download_url;
                        
                        // Create download link
                        qrContainer.innerHTML = `<strong>APK Download</strong>`;
                        
                        // Create QR code canvas
                        const qrCanvas = document.createElement('canvas');
                        qrContainer.appendChild(qrCanvas);
                        
                            // Add download URL that doesn't require a token
                        const downloadLink = document.createElement('a');
                            downloadLink.href = directDownloadUrl;
                        downloadLink.className = 'btn';
                        downloadLink.style.marginTop = '10px';
                        downloadLink.style.fontSize = '14px';
                        downloadLink.textContent = 'Download APK';
                        qrContainer.appendChild(downloadLink);
                            
                            // Generate QR code for the direct download link (no token needed)
                            generateQRCode(directDownloadUrl, qrCanvas);
                            
                            // Add QR code explanation
                            const qrExplanation = document.createElement('p');
                            qrExplanation.style.fontSize = '12px';
                            qrExplanation.style.marginTop = '5px';
                            qrExplanation.textContent = 'Scan with your phone to download';
                            qrContainer.appendChild(qrExplanation);
                        }
                        
                        buildItem.appendChild(qrContainer);
                    }
                    
                    buildsList.appendChild(buildItem);
                }
                
            } catch (error) {
                console.error('Error checking builds:', error);
                document.getElementById('builds-list').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });
        
        // Generate a unique build ID
        function generateBuildId() {
            return `build-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }
        
        // Save build to localStorage
        function saveBuild(build) {
            const builds = JSON.parse(localStorage.getItem('webviewAppBuilds') || '[]');
            builds.unshift(build); // Add to beginning of array
            if (builds.length > 20) builds.pop(); // Keep only last 20 builds
            localStorage.setItem('webviewAppBuilds', JSON.stringify(builds));
        }
    </script>
</body>
</html> 