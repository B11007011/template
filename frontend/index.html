<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Builder</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
        }
        h1 {
            margin-bottom: 30px;
        }
        h2 {
            margin-top: 30px;
            font-size: 1.5em;
        }
        .form-container, .builds-container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input[type="text"],
        input[type="url"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button, .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            width: 100%;
            transition: background-color 0.3s;
            text-align: center;
            text-decoration: none;
        }
        button:hover, .btn:hover {
            background-color: #2980b9;
        }
        .build-list {
            list-style: none;
            padding: 0;
        }
        .build-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .build-info {
            flex: 1;
            min-width: 250px;
        }
        .build-qr {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
        }
        .build-qr img {
            max-width: 150px;
            margin-top: 10px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .hidden {
            display: none;
        }
        .tab-container {
            margin-top: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            width: auto;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
        }
        .loading-container {
            text-align: center;
            padding: 30px 0;
        }
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .app-ready-container {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
        }
        .app-info {
            flex: 1;
            min-width: 300px;
        }
        .app-qr {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .warning-box {
            background-color: #fff3cd;
            color: #856404;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            padding-left: 50px;
        }
        .warning-box::before {
            content: "⚠️";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
        }
        .download-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .download-icon {
            width: 40px;
            height: 40px;
            background-color: #673ab7;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>App Builder</h1>
    
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="build-form">Build New App</button>
            <button class="tab-button" data-tab="past-builds">Previous Builds</button>
        </div>
        
        <div class="tab-content" id="build-form">
            <div class="form-container">
                <!-- All GitHub and backend fields are hidden -->
                <input type="hidden" id="github-token">
                <input type="hidden" id="repo-owner">
                <input type="hidden" id="repo-name">
                <input type="hidden" id="auth-status">
                
                <div class="form-group">
                    <label for="app-name">App Name:</label>
                    <input type="text" id="app-name" placeholder="WebView App" required>
                </div>
                
                <div class="form-group">
                    <label for="webview-url">Website URL:</label>
                    <input type="url" id="webview-url" placeholder="https://example.com" required>
                </div>
                
               
                <button id="trigger-build">Trigger Build</button>
            </div>
            
            <div id="result" class="result hidden"></div>
            
            <!-- Building in progress UI -->
            <div id="building-progress" class="hidden">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <h2>Building Your App...</h2>
                    <p>This process may take a few minutes. Please wait while we compile your Android application.</p>
                </div>
            </div>
            
            <!-- App ready UI (similar to screenshot) -->
            <div id="app-ready" class="hidden">
                <h2>Your App is Ready</h2>
                
                <div class="warning-box">
                    Installing an app from direct APK file will show a 'Google Play Protect' or virus detection warning. This warning is default by Android OS and will be gone when published to Google Play Store.
                </div>
                
                <div class="app-ready-container">
                    <div class="app-info">
                        <h3>Download App</h3>
                        
                        <div class="download-option">
                            <div class="download-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 17l2-2 4 4 8-8 2 2-10 10L3 17z"></path>
                                </svg>
                            </div>
                            <div>
                                <div><strong>Download APK</strong></div>
                                <div>Android Application Package</div>
                                <div><small id="build-date">Generated just now</small></div>
                            </div>
                            <a href="#" id="download-apk-btn" class="btn" style="width: auto; margin-left: auto; padding: 8px 15px;">Download</a>
                        </div>
                        
                        <div class="download-option">
                            <div class="download-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="8 18 12 22 16 18"></polyline>
                                    <path d="M12 2v20"></path>
                                </svg>
                            </div>
                            <div>
                                <div><strong>Download AAB</strong></div>
                                <div>Android App Bundle</div>
                                <div><small>For Google Play submission</small></div>
                            </div>
                            <a href="#" id="download-aab-btn" class="btn" style="width: auto; margin-left: auto; padding: 8px 15px; background-color: #673ab7;">Upgrade Plan</a>
                        </div>
                    </div>
                    
                    <div class="app-qr">
                        <canvas id="app-qr-code"></canvas>
                        <p>Scan to get the APK file download URL</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content hidden" id="past-builds">
            <div class="builds-container">
                <h2>Your Recent Builds</h2>
                
                <!-- All GitHub and backend fields are hidden -->
                <input type="hidden" id="check-github-token">
                <input type="hidden" id="check-repo-owner">
                <input type="hidden" id="check-repo-name">
                <input type="hidden" id="check-auth-status">
                
                <button id="check-builds">Check Recent Builds</button>
                
                <div id="builds-list" class="build-list"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <script>
        // Firebase configuration
        let firebaseApp = null;
        let firestore = null;
        let firestoreUnsubscribe = null;
        
        // Initialize Firebase if config exists
        function initFirebase() {
            try {
                if (typeof CONFIG !== 'undefined' && CONFIG.firebase && CONFIG.firebase.apiKey) {
                    firebaseApp = firebase.initializeApp(CONFIG.firebase);
                    firestore = firebaseApp.firestore();
                    console.log('Firebase initialized');
                    return true;
                }
            } catch (error) {
                console.warn('Firebase initialization error:', error);
            }
            return false;
        }
        
        // Subscribe to build status changes in Firestore
        function subscribeToFirestoreUpdates(buildId) {
            if (!firestore || !buildId) return;
            
            // Unsubscribe from any previous listener
            if (firestoreUnsubscribe) {
                firestoreUnsubscribe();
                firestoreUnsubscribe = null;
            }
            
            // Create a reference to the build document
            const buildRef = firestore.collection('builds').doc(buildId);
            
            // Watch for updates to the build status
            firestoreUnsubscribe = buildRef.onSnapshot(
                (doc) => {
                    if (doc.exists) {
                        const buildData = doc.data();
                        updateBuildProgress(buildData);
                    }
                },
                (error) => {
                    console.error('Firestore listener error:', error);
                }
            );
            
            console.log(`Subscribed to Firestore updates for build ID: ${buildId}`);
        }
        
        // Update UI based on Firestore build status
        function updateBuildProgress(buildData) {
            const buildingProgress = document.getElementById('building-progress');
            const progressText = buildingProgress.querySelector('p');
            const resultDiv = document.getElementById('result');
            const appReady = document.getElementById('app-ready');
            
            // Update progress text
            if (buildData.status === 'pending' || buildData.status === 'in_progress') {
                progressText.textContent = `Building your app... (Status: ${buildData.status})`;
                buildingProgress.classList.remove('hidden');
                appReady.classList.add('hidden');
                
                // Update progress message if available
                if (buildData.progressMessage) {
                    progressText.textContent = buildData.progressMessage;
                }
            } 
            else if (buildData.status === 'completed') {
                // Build is complete, show download options
                buildingProgress.classList.add('hidden');
                
                // Set the build date
                document.getElementById('build-date').textContent = `Generated ${new Date(buildData.completedAt).toLocaleDateString()}`;
                
                // Check for artifact URLs
                if (buildData.artifactUrls && buildData.artifactUrls.apk) {
                    // Get the GitHub artifact URL and convert to our proxy URL
                    const artifactUrl = buildData.artifactUrls.apk;
                    const token = document.getElementById('github-token').value;
                    const buildId = buildData.id || 'unknown';
                    const appName = buildData.appName || 'WebView-App';
                    const appFileName = `${appName.replace(/\s+/g, '-')}-${buildId}.apk`;
                    
                    // Use our API to get the download URL
                    createDownloadLink(token, artifactUrl, appFileName);
                }
                
                // Show the app ready container
                appReady.classList.remove('hidden');
            } 
            else if (buildData.status === 'failed') {
                // Build failed, show error
                buildingProgress.classList.add('hidden');
                resultDiv.innerHTML = `
                    <p>Build failed: ${buildData.errorMessage || 'Unknown error'}</p>
                    <p>Please check the workflow logs for details.</p>
                `;
                resultDiv.className = 'result error';
            }
        }
        
        // Create download link using our API
        async function createDownloadLink(token, artifactUrl, filename) {
            try {
                // Extract artifact ID from URL if present
                let match = artifactUrl.match(/\/actions\/runs\/(\d+)/);
                if (!match) return;
                
                const runId = match[1];
                const owner = document.getElementById('repo-owner').value;
                const repo = document.getElementById('repo-name').value;
                
                // First get the artifacts for this run
                const artifactsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${runId}/artifacts`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!artifactsResponse.ok) {
                    throw new Error(`GitHub API error: ${artifactsResponse.status}`);
                }
                
                const artifactsData = await artifactsResponse.json();
                
                // Find the APK artifact
                const apkArtifact = artifactsData.artifacts.find(a => a.name === 'android-apk');
                if (!apkArtifact) {
                    throw new Error('No APK artifact found');
                }
                
                // Get the download URL
                const artifact_url = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${apkArtifact.id}/zip`;
                
                // Use our proxy download API
                const proxyResponse = await fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifact_url)}&filename=${encodeURIComponent(filename)}`);
                const proxyData = await proxyResponse.json();
                
                if (proxyResponse.ok && proxyData.success) {
                    // Get the direct download URL from our server
                    const directDownloadUrl = window.location.origin + proxyData.download_url;
                    
                    // Set the download button URL
                    const downloadBtn = document.getElementById('download-apk-btn');
                    downloadBtn.href = directDownloadUrl;
                    
                    // Generate QR code for the download link
                    const qrCanvas = document.getElementById('app-qr-code');
                    generateQRCode(directDownloadUrl, qrCanvas);
                }
            } catch (error) {
                console.error('Error creating download link:', error);
            }
        }
        
        // Save settings in localStorage
        function saveSettings() {
            const settings = {
                repoOwner: document.getElementById('repo-owner').value,
                repoName: document.getElementById('repo-name').value,
                token: document.getElementById('github-token').value
            };
            localStorage.setItem('webviewAppSettings', JSON.stringify(settings));
        }
        
        // Load settings from localStorage
        function loadSettings() {
            // Default values
            const defaultValues = {
                repoOwner: 'B11007011',
                repoName: 'template',
                token: '' // No default token here
            };
            
            const settings = JSON.parse(localStorage.getItem('webviewAppSettings') || '{}');
            
            // Set default values first, then override with stored settings if they exist
            document.getElementById('repo-owner').value = defaultValues.repoOwner;
            document.getElementById('repo-name').value = defaultValues.repoName;
            
            // If there are stored settings, use them to override defaults
            if (settings.repoOwner) document.getElementById('repo-owner').value = settings.repoOwner;
            if (settings.repoName) document.getElementById('repo-name').value = settings.repoName;
            if (settings.token) document.getElementById('github-token').value = settings.token;
            
            // Copy the values to the "check builds" form too
            document.getElementById('check-repo-owner').value = document.getElementById('repo-owner').value;
            document.getElementById('check-repo-name').value = document.getElementById('repo-name').value;
            document.getElementById('check-github-token').value = document.getElementById('github-token').value;
            
            // Update auth status display based on token availability
            updateAuthStatus();
        }
        
        // Update authentication status messages
        function updateAuthStatus() {
            // No longer need to update UI elements since they're hidden
            // Just verify the token status in the background
            const hasToken = document.getElementById('github-token').value !== '';
            console.log('Authentication status:', hasToken ? 'Configured' : 'Not configured');
        }
        
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                // Show the selected tab content
                document.getElementById(button.dataset.tab).classList.remove('hidden');
            });
        });
        
        // Create QR code
        function generateQRCode(url, element) {
            QRCode.toCanvas(element, url, { width: 150 }, function (error) {
                if (error) console.error(error);
            });
        }
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', async function() {
            loadSettings();
            
            // Try to get default token ID from server
            try {
                const response = await fetch('/api/default-token');
                const data = await response.json();
                
                if (data.success && data.tokenId) {
                    // Store the token ID in a hidden input
                    const tokenIdInput = document.createElement('input');
                    tokenIdInput.type = 'hidden';
                    tokenIdInput.id = 'default-token-id';
                    tokenIdInput.value = data.tokenId;
                    document.body.appendChild(tokenIdInput);
                    
                    // Update owner/repo if provided and not already set by user
                    if (data.owner && !document.getElementById('repo-owner').value) {
                        document.getElementById('repo-owner').value = data.owner;
                    }
                    if (data.repo && !document.getElementById('repo-name').value) {
                        document.getElementById('repo-name').value = data.repo;
                    }
                    
                    // Mark as having a token
                    document.getElementById('github-token').value = 'default-token-configured';
                    
                    // Also update check builds form
                    document.getElementById('check-repo-owner').value = document.getElementById('repo-owner').value;
                    document.getElementById('check-repo-name').value = document.getElementById('repo-name').value;
                    document.getElementById('check-github-token').value = document.getElementById('github-token').value;
                    
                    // Update auth status
                    updateAuthStatus();
                }
            } catch (error) {
                console.warn('Could not fetch default token:', error);
            }
        });
        
        document.getElementById('trigger-build').addEventListener('click', async function() {
            const token = document.getElementById('github-token').value;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            const appName = document.getElementById('app-name').value;
            const webviewUrl = document.getElementById('webview-url').value;
            const buildId = generateBuildId();
            
            // Save settings
            saveSettings();
            
            const resultDiv = document.getElementById('result');
            const buildingProgress = document.getElementById('building-progress');
            const appReady = document.getElementById('app-ready');
            
            resultDiv.className = 'result hidden';
            appReady.classList.add('hidden');
            
            // Validate inputs
            if (!token || !owner || !repo || !appName || !webviewUrl) {
                resultDiv.textContent = 'Please fill in all required fields';
                resultDiv.className = 'result error';
                return;
            }
            
            // Show building progress
            buildingProgress.classList.remove('hidden');
            const progressText = buildingProgress.querySelector('p');
            const originalProgressText = progressText.textContent;
            
            // If Firebase is initialized, start listening for updates
            if (firestore) {
                // Create initial Firestore document for this build
                try {
                    const buildRef = firestore.collection('builds').doc(buildId);
                    await buildRef.set({
                        id: buildId,
                        appName: appName,
                        webviewUrl: webviewUrl,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        owner: owner,
                        repo: repo
                    });
                    
                    // Subscribe to updates for this build
                    subscribeToFirestoreUpdates(buildId);
                } catch (error) {
                    console.warn('Error creating Firestore document:', error);
                    // Continue with normal processing even if Firestore fails
                }
            }
            
            try {
                // Method 1: Using workflow_dispatch event
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/build.yaml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ref: 'main', // or whichever branch you want to run the workflow on
                        inputs: {
                            app_name: appName,
                            url: webviewUrl,
                            build_id: buildId
                        }
                    })
                });
                
                if (response.status === 204) {
                    // Store this build in localStorage
                    const buildData = {
                        id: buildId,
                        appName,
                        webviewUrl,
                        owner,
                        repo,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    saveBuild(buildData);
                    
                    // Poll for build status
                    let buildCompleted = false;
                    let buildRunId = null;
                    let artifacts = null;
                    let pollingCount = 0;
                    
                    const checkBuildStatus = async () => {
                        pollingCount++;
                        progressText.textContent = `${originalProgressText} (Checking status: attempt ${pollingCount})`;
                        
                        try {
                            // Find our workflow run
                            const workflowsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=5`, {
                                headers: {
                                    'Authorization': `token ${token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (!workflowsResponse.ok) {
                                throw new Error(`GitHub API error: ${workflowsResponse.status}`);
                            }
                            
                            const workflowsData = await workflowsResponse.json();
                            
                            // Try to find our specific run by buildId in the name/title
                            const ourRun = workflowsData.workflow_runs.find(run => {
                                return run.name === 'Android Build' && 
                                       (run.display_title?.includes(buildId) || run.head_commit?.message?.includes(buildId));
                            });
                            
                            if (ourRun) {
                                buildRunId = ourRun.id;
                                
                                if (ourRun.status === 'completed') {
                                    if (ourRun.conclusion === 'success') {
                                        // Build successful - get artifacts
                                        const artifactsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${buildRunId}/artifacts`, {
                                            headers: {
                                                'Authorization': `token ${token}`,
                                                'Accept': 'application/vnd.github.v3+json'
                                            }
                                        });
                                        
                                        if (artifactsResponse.ok) {
                                            artifacts = await artifactsResponse.json();
                                            buildCompleted = true;
                                        }
                                    } else {
                                        // Build failed
                                        buildCompleted = true;
                                        buildingProgress.classList.add('hidden');
                                        resultDiv.innerHTML = `
                                            <p>Build failed with status: ${ourRun.conclusion}</p>
                                            <p>Please check the <a href="${ourRun.html_url}" target="_blank">workflow logs</a> for details.</p>
                                        `;
                                        resultDiv.className = 'result error';
                                    }
                                } else {
                                    // Still running
                                    progressText.textContent = `Building your app... (Status: ${ourRun.status})`;
                                }
                            }
                            
                            if (buildCompleted) {
                                clearInterval(pollingInterval);
                                
                                if (artifacts && artifacts.artifacts.length > 0) {
                        buildingProgress.classList.add('hidden');
                        
                                    // Process artifacts to get download links
                                    const apkArtifact = artifacts.artifacts.find(a => a.name === 'android-apk');
                                    
                                    if (apkArtifact) {
                        // Set the build date
                        document.getElementById('build-date').textContent = `Generated ${new Date().toLocaleDateString()}`;
                        
                                        // Get artifact download URL 
                                        const artifactUrl = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${apkArtifact.id}/zip`;
                                        const appFileName = `${appName.replace(/\s+/g, '-')}-${buildId}.apk`;
                                        
                                        try {
                                            // Use proxy API to get direct download link
                                            const proxyResponse = await fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                                            const proxyData = await proxyResponse.json();
                                            
                                            if (proxyResponse.ok && proxyData.success) {
                                                // Get the direct download URL from our server
                                                const directDownloadUrl = window.location.origin + proxyData.download_url;
                        
                        // Set the download button
                        const downloadBtn = document.getElementById('download-apk-btn');
                                                downloadBtn.href = directDownloadUrl;
                        
                        // Generate QR code
                        const qrCanvas = document.getElementById('app-qr-code');
                                                generateQRCode(directDownloadUrl, qrCanvas);
                        
                        // Show app ready view
                        appReady.classList.remove('hidden');
                                            } else {
                                                throw new Error(proxyData.error || 'Failed to process download URL');
                                            }
                                        } catch (error) {
                                            resultDiv.textContent = `Error preparing download: ${error.message}`;
                                            resultDiv.className = 'result error';
                                        }
                                    } else {
                                        resultDiv.textContent = 'Build completed but no APK artifact was found';
                                        resultDiv.className = 'result error';
                                    }
                                } else {
                                    resultDiv.textContent = 'Build completed but no artifacts were generated';
                                    resultDiv.className = 'result error';
                                }
                            }
                        } catch (error) {
                            console.error('Error polling build status:', error);
                            
                            // Don't stop polling on error, try again next time
                            if (pollingCount > 30) { // Stop after ~5 minutes
                                clearInterval(pollingInterval);
                                buildingProgress.classList.add('hidden');
                                resultDiv.textContent = `Error checking build status: ${error.message}`;
                                resultDiv.className = 'result error';
                            }
                        }
                    };
                    
                    // Check immediately first
                    await checkBuildStatus();
                    
                    // Then set up polling every 10 seconds
                    const pollingInterval = setInterval(checkBuildStatus, 10000);
                    
                    // Add a 5 minute timeout to prevent indefinite polling
                    setTimeout(() => {
                        if (!buildCompleted) {
                            clearInterval(pollingInterval);
                            buildingProgress.classList.add('hidden');
                            resultDiv.innerHTML = `
                                <p>Build is taking longer than expected.</p>
                                <p>You can check the status in the "Previous Builds" tab or on GitHub Actions.</p>
                            `;
                            resultDiv.className = 'result';
                        }
                    }, 300000); // 5 minutes
                    
                } else {
                    buildingProgress.classList.add('hidden');
                    const error = await response.json();
                    throw new Error(`GitHub API error: ${error.message}`);
                }
            } catch (error) {
                buildingProgress.classList.add('hidden');
                console.error('Error:', error);
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        });
        
        document.getElementById('check-builds').addEventListener('click', async function() {
            let token = document.getElementById('check-github-token').value;
            const owner = document.getElementById('check-repo-owner').value;
            const repo = document.getElementById('check-repo-name').value;
            
            // Use default token ID if available
            const defaultTokenId = document.getElementById('default-token-id')?.value;
            
            if ((!token && !defaultTokenId) || !owner || !repo) {
                alert('Configuration error. Please refresh the page or contact support.');
                return;
            }
            
            try {
                // Show loading indicator in the builds list
                const buildsList = document.getElementById('builds-list');
                buildsList.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Checking for completed builds...</p></div>';
                
                // Get workflows runs
                let response;
                
                if (token) {
                    // Use provided token directly
                    response = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?status=completed&per_page=10`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                } else {
                    // Use API that works with token ID
                    response = await fetch(`/api/github-proxy/actions/runs?owner=${encodeURIComponent(owner)}&repo=${encodeURIComponent(repo)}&tokenId=${encodeURIComponent(defaultTokenId)}`);
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                buildsList.innerHTML = '';
                
                if (data.workflow_runs.length === 0) {
                    buildsList.innerHTML = '<p>No completed builds found.</p>';
                    return;
                }
                
                // Loop through workflow runs and get artifacts
                for (const run of data.workflow_runs) {
                    if (run.name !== 'Android Build') continue;
                    
                    const artifactsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs/${run.id}/artifacts`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!artifactsResponse.ok) {
                        console.error(`Error fetching artifacts for run ${run.id}: ${artifactsResponse.status}`);
                        continue;
                    }
                    
                    const artifactsData = await artifactsResponse.json();
                    
                    const buildItem = document.createElement('div');
                    buildItem.className = 'build-item';
                    
                    const buildInfo = document.createElement('div');
                    buildInfo.className = 'build-info';
                    
                    // Extract parameters from run
                    let appName = "Unknown App";
                    let webviewUrl = "#";
                    let buildId = "unknown";
                    
                    try {
                        if (run.display_title.includes('"app_name":')) {
                            appName = run.display_title.match(/"app_name":"([^"]+)"/)[1];
                        }
                        if (run.display_title.includes('"url":')) {
                            webviewUrl = run.display_title.match(/"url":"([^"]+)"/)[1];
                        }
                        if (run.display_title.includes('"build_id":')) {
                            buildId = run.display_title.match(/"build_id":"([^"]+)"/)[1];
                        }
                    } catch (e) {
                        console.error("Error parsing run title", e);
                    }
                    
                    buildInfo.innerHTML = `
                        <h3>${appName || 'App Build'}</h3>
                        <p><strong>Built on:</strong> ${new Date(run.created_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${run.conclusion === 'success' ? '✅ Success' : '❌ Failed'}</p>
                        <p><strong>WebView URL:</strong> ${webviewUrl}</p>
                        <p><strong>Build ID:</strong> ${buildId || 'N/A'}</p>
                        <a href="${run.html_url}" target="_blank" class="btn">View Workflow Details</a>
                    `;
                    
                    buildItem.appendChild(buildInfo);
                    
                    // Find APK artifact
                    const apkArtifact = artifactsData.artifacts.find(a => a.name === 'android-apk');
                    if (apkArtifact) {
                        const qrContainer = document.createElement('div');
                        qrContainer.className = 'build-qr';
                        
                        // Instead of direct GitHub download URL, use our proxy API
                        const artifactUrl = `https://api.github.com/repos/${owner}/${repo}/actions/artifacts/${apkArtifact.id}/zip`;
                        const appFileName = `${appName.replace(/\s+/g, '-')}-${buildId}.apk`;
                        
                        // Show loading message while getting the download link
                        qrContainer.innerHTML = `<div class="loading-spinner" style="width: 30px; height: 30px;"></div><p>Preparing download link...</p>`;
                        buildItem.appendChild(qrContainer);
                        
                        try {
                            // Use our proxy download API to get a direct download link
                            const proxyResponse = await fetch(`/api/download?token=${encodeURIComponent(token)}&artifact_url=${encodeURIComponent(artifactUrl)}&filename=${encodeURIComponent(appFileName)}`);
                            const proxyData = await proxyResponse.json();
                            
                            if (!proxyResponse.ok || !proxyData.success) {
                                qrContainer.innerHTML = `<strong>APK Download Failed</strong><p>Error: ${proxyData.error || 'Unknown error'}</p>`;
                            } else {
                                // Get the direct download URL from our server
                                const directDownloadUrl = window.location.origin + proxyData.download_url;
                                
                                // Create download link
                                qrContainer.innerHTML = `<strong>APK Download</strong>`;
                                
                                // Create QR code canvas
                                const qrCanvas = document.createElement('canvas');
                                qrContainer.appendChild(qrCanvas);
                                
                                // Add download URL that doesn't require a token
                                const downloadLink = document.createElement('a');
                                downloadLink.href = directDownloadUrl;
                                downloadLink.className = 'btn';
                                downloadLink.style.marginTop = '10px';
                                downloadLink.style.fontSize = '14px';
                                downloadLink.textContent = 'Download APK';
                                qrContainer.appendChild(downloadLink);
                                
                                // Generate QR code for the direct download link (no token needed)
                                generateQRCode(directDownloadUrl, qrCanvas);
                                
                                // Add QR code explanation
                                const qrExplanation = document.createElement('p');
                                qrExplanation.style.fontSize = '12px';
                                qrExplanation.style.marginTop = '5px';
                                qrExplanation.textContent = 'Scan with your phone to download';
                                qrContainer.appendChild(qrExplanation);
                            }
                        } catch (error) {
                            qrContainer.innerHTML = `<strong>APK Download Failed</strong><p>Error: ${error.message}</p>`;
                        }
                    }
                    
                    buildsList.appendChild(buildItem);
                }
                
            } catch (error) {
                console.error('Error checking builds:', error);
                document.getElementById('builds-list').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });
        
        // Generate a unique build ID
        function generateBuildId() {
            return `build-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }
        
        // Save build to localStorage
        function saveBuild(build) {
            const builds = JSON.parse(localStorage.getItem('webviewAppBuilds') || '[]');
            builds.unshift(build); // Add to beginning of array
            if (builds.length > 20) builds.pop(); // Keep only last 20 builds
            localStorage.setItem('webviewAppBuilds', JSON.stringify(builds));
        }
    </script>
</body>
</html> 